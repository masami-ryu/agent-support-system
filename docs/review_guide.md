# コードレビュー観点ガイド (for GitHub Copilot & Human Reviewers)

> 補助: 具体的な Copilot への指示テンプレートは [copilot_prompts.md](./copilot_prompts.md) を参照してください。

このガイドは Pull Request レビュー時に GitHub Copilot や人が一貫した指摘を行えるようにするための詳細観点集です。PR テンプレートから参照され、自動レビュー支援にも利用されます。

---
### 言語ポリシー (Language Policy)
レビューコメント (人間 / Copilot 生成を含む) は原則 **日本語** で記述してください。<br/>
理由: チームでの認識齟齬防止・ナレッジ蓄積一貫性向上・オンボーディング効率化。

Copilot / Chat へ英語プロンプトを投入する場合でも、最終出力を日本語に統一するため以下のラッパを併用できます:
```
Always return the final answer strictly in natural Japanese. Keep code identifiers and proper nouns in original language.
```
コード断片にコメントを追加する際の推奨フォーマット例:
```
[must] この関数は責務が大きいため分割を検討してください (例: 検証処理と永続化処理を分離)。
```
英語出力が混入した場合は後述の自動チェック (GitHub Actions) が注意コメントを投稿する可能性があります。

---
## 0. コメント記法 & 重大度ルール
- 接頭辞 (既存ルール): `[must]`, `[imo]`, `[nits]`, `[ask]`, `[fyi]`
- 追加推奨接頭辞: `[sec]` セキュリティ, `[perf]` パフォーマンス, `[test]` テスト, `[docs]` ドキュメント, `[ux]` 利便性
- 1コメント1論点。複数論点はスレッド分割。
- 回避策/修正例をできるだけ含める。

### 重大度目安
| 接頭辞 | 意味 | マージ前必須 |
|--------|------|---------------|
| `[must]` | 欠陥 / 要件不達 | YES |
| `[sec]` | セキュリティ影響重大 | YES |
| `[perf]` | クリティカル性能劣化 | 状況により |
| `[imo]` | 任意改善 | NO |
| `[nits]` | 微細表記揺れ等 | NO |
| `[ask]` | 理解確認 | NO (回答後判断) |
| `[fyi]` | 参考 | NO |

---
## 1. 変更概要の明確性
- PR タイトルは「何を / なぜ」を 60 字以内で要約しているか。
- 説明に作業内容が記載されているか。

## 2. 設計・アーキテクチャ
- 単一責任: クラス/モジュールは 1 機能に集中しているか。
- 新規抽象の導入根拠は説明されているか。
- 循環依存や層違反が増えていないか。
- データフロー / 依存方向が既存指針に沿うか。

## 3. 可読性 & 保守性
- 命名はドメイン語彙を反映し曖昧語 (data, info, util) を避けているか。
- 不要なコメントより自己説明的コード優先か。
- 複雑度 (ネスト >3, 関数長過大) を抑制しているか。
- Magic number/文字列に定数化が必要か。
- Dead code / 未使用 import / デバッグ出力が残っていないか。

## 4. エラーハンドリング & 例外設計
- 失敗パスは明示されログ/再試行/フォールバック戦略が一貫か。
- 例外メッセージは原因 + 影響 + 次アクションを示すか。
- サイレント失敗や握り潰しは無いか。

## 5. セキュリティ `[sec]`
- 入力値検証: 外部入力 (API, ENV, ユーザー入力) を適切にバリデートしているか。
- 認可/認証チェック抜け・順序ミスはないか。
- 秘密情報 (APIキー, トークン, パスワード) がログ/コードに含まれていないか。
- 依存ライブラリ更新で既知 CVE を解消しているか。
- コマンド/SQL/テンプレートインジェクション対策 (エスケープ, プレースホルダ) を行っているか。
- 暗号利用: 既存共通ユーティリティ/推奨アルゴリズムを使っているか。

## 6. パフォーマンス `[perf]`
- 不要な同期 I/O / 重複計算 / N+1 / 全件ロードはないか。
- 大きなデータ構造コピーや無駄なオブジェクト生成を回避しているか。
- 遅延ロード / キャッシュ / ストリーム化の適用余地はあるか。
- アルゴリズム計算量は妥当か (O(n^2) → O(n log n) 改善余地など)。

## 7. 並行性 / スレッド / 非同期
- 共有状態保護 (ロック / アトミック) が正しく粒度過大/過小でないか。
- デッドロック順序/レース条件の懸念はないか。
- 非同期エラーが正しく await / ハンドルされているか。

## 8. テスト `[test]`
- 新機能/バグ修正はユニット/統合テストが追加・更新されているか。
- Red-Green を裏付ける再現テストがあるか (バグ時)。
- テストは結果だけでなく境界/エラー/空ケースを網羅しているか。
- テストが実装詳細に過度に結合していないか (壊れやすさ)。

## 9. ドキュメント & コミュニケーション `[docs]`
- README / CHANGELOG / マイグレーション手順が必要に応じ更新されたか。
- 公開API変更が破壊的影響の記述があるか。
- コメントは WHY を説明し WHAT の重複を避けているか。

## 10. アクセシビリティ / 国際化 `[ux]`
- UIテキストは翻訳キー化されているか (必要な場合)。
- コントラスト / キーボード操作 / ARIA 属性など基本要件を侵していないか。

## 11. ログ・監視 / オブザーバビリティ
- ログレベル適切か (ERROR: 例外, WARN: 想定外, INFO: 主要イベント, DEBUG: 詳細)。
- PII / 機微情報をログしていないか。
- 新しい計測指標 (メトリクス, トレース) が必要なら追加したか。

## 12. 依存関係 / ビルド / CI
- 新規依存は目的・比較検討理由が明示されているか。
- バージョンピン/範囲がポリシーに沿うか。
- CI 失敗を無視していないか。Lint / Format 適用済みか。

## 13. インフラ / IaC / デプロイ
- 環境変数や構成値が過不足なく記述されているか。
- ロールバック手順 / フィーチャーフラグ戦略は明示か。
- ステートフル変更 (DB migration 等) の順序/可逆性を検証しているか。

## 14. リスク & ロールバック戦略
- 失敗時の影響範囲評価があるか。
- フィーチャーフラグ / 段階的リリース / Canary 可能性の説明はあるか。
- ロールバック手順 (どの commit/ migration を戻すか) が明示か。

## 15. 追加で投げられる質問例 `[ask]`
- この設計を 6 ヶ月後スケールさせる際のボトルネックは何ですか?
- キャッシュ不整合時の挙動は?
- 代替案 A/B を比較検討しましたか?
- テストでカバーされないリスクは?
- 本番障害時にデバッグ開始する最初の指標は?

## 16. 指摘の書き方サンプル
```
[must] 入力値Xがバリデートされていません。例: isValidId() を利用し 400 を返して早期終了する案です。
[perf] ここはループ内で DB 呼び出しを行っており N+1 です。先に id 一覧でまとめて取得する形にできそうです。
[sec] ハードコードされたトークンが残っています。環境変数参照と .env.example の更新をお願いします。
```

## 17. Copilot に期待する自動レビュー例 (プロンプト化方針)
- 重大度 `[must]` レベルのコードスメル/バグ候補列挙。
- 新規/変更ファイルで未使用 import, 未使用変数の指摘。
- 明らかな循環参照や巨大関数 (> 80行) の報告。
- セキュリティ: 外部入力の未サニタイズ使用パターン検出。

## 18. 適用の進め方
1. PR 作成者はセルフレビューで本ガイドを走査し未対応を先に修正。
2. Draft → Open へ移行時に最小差分化 (不要変更除去)。
3. レビュワーは高→低重大度順にレビュー。
4. 全 `[must]/[sec]` 解消 + 合意形成後マージ。


---
このファイルは継続的に改善します。改善案は PR で `[docs]` タグを付けて提案してください。
